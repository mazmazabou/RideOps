const http = require('http');
const fs = require('fs');
const path = require('path');
const url = require('url');

function express() {
  const routes = [];
  const middlewares = [];

  function app(req, res) {
    enhanceResponse(res);
    const parsed = url.parse(req.url, true);
    req.path = parsed.pathname;
    req.query = parsed.query || {};
    req.params = {};

    let idx = 0;
    function next() {
      if (idx < middlewares.length) {
        const mw = middlewares[idx++];
        mw(req, res, next);
        return;
      }
      const routeMatch = findRoute(req.method, req.path, routes);
      if (routeMatch) {
        req.params = routeMatch.params;
        return routeMatch.handler(req, res);
      }
      res.statusCode = 404;
      res.end('Not Found');
    }
    next();
  }

  app.use = function (fn) {
    middlewares.push(fn);
  };

  ['GET', 'POST', 'DELETE'].forEach((method) => {
    app[method.toLowerCase()] = function (routePath, handler) {
      routes.push({ method, path: routePath, handler });
    };
  });

  app.listen = function (port, cb) {
    const server = http.createServer(app);
    server.listen(port, cb);
    return server;
  };

  return app;
}

function enhanceResponse(res) {
  res.json = function (data) {
    res.setHeader('Content-Type', 'application/json');
    res.end(JSON.stringify(data));
  };
  res.send = function (data) {
    if (typeof data === 'object') {
      res.json(data);
    } else {
      res.end(data);
    }
  };
  res.status = function (code) {
    res.statusCode = code;
    return res;
  };
}

function findRoute(method, requestPath, routes) {
  for (const r of routes) {
    if (r.method !== method) continue;
    const match = matchPath(r.path, requestPath);
    if (match) {
      return { handler: r.handler, params: match };
    }
  }
  return null;
}

function matchPath(routePath, requestPath) {
  const routeParts = routePath.split('/').filter(Boolean);
  const reqParts = requestPath.split('/').filter(Boolean);
  if (routeParts.length !== reqParts.length) return null;
  const params = {};
  for (let i = 0; i < routeParts.length; i++) {
    if (routeParts[i].startsWith(':')) {
      params[routeParts[i].slice(1)] = decodeURIComponent(reqParts[i]);
    } else if (routeParts[i] !== reqParts[i]) {
      return null;
    }
  }
  return params;
}

express.json = function () {
  return function (req, res, next) {
    let body = '';
    req.on('data', (chunk) => {
      body += chunk;
    });
    req.on('end', () => {
      if (body) {
        try {
          req.body = JSON.parse(body);
        } catch (err) {
          req.body = {};
        }
      } else {
        req.body = {};
      }
      next();
    });
  };
};

express.static = function (dir) {
  return function (req, res, next) {
    if (req.method !== 'GET' && req.method !== 'HEAD') return next();
    const filePath = path.join(dir, decodeURIComponent(req.path || req.url.split('?')[0]));
    if (!filePath.startsWith(path.resolve(dir))) {
      res.status(403).send('Forbidden');
      return;
    }
    fs.stat(filePath, (err, stats) => {
      if (err || !stats.isFile()) return next();
      const stream = fs.createReadStream(filePath);
      res.setHeader('Content-Type', getContentType(filePath));
      stream.pipe(res);
    });
  };
};

function getContentType(filePath) {
  const ext = path.extname(filePath);
  switch (ext) {
    case '.html':
      return 'text/html';
    case '.css':
      return 'text/css';
    case '.js':
      return 'application/javascript';
    case '.json':
      return 'application/json';
    default:
      return 'text/plain';
  }
}

module.exports = express;
