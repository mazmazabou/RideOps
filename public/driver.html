<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Console</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.2.0/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.31.0/tabler-icons.min.css">
  <link rel="stylesheet" href="/css/rideops-theme.css">
  <script src="/js/rideops-utils.js"></script>
  <script src="/demo-config.js"></script>
  <style>
    .driver-header { position: sticky; top: 0; z-index: 20; height: 48px; background: var(--color-surface); border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; }
    .driver-header__left { display: flex; align-items: center; gap: 8px; }
    .driver-header__left span { font-weight: 700; font-size: 14px; }
    .driver-header__right { display: flex; align-items: center; gap: 10px; }
    .driver-header__right #driver-name { font-size: 13px; color: var(--color-text-secondary); }
    .driver-main { max-width: 600px; margin: 0 auto; padding: 16px; }
  </style>
</head>
<body style="padding-bottom:56px;">
  <header class="driver-header">
    <div class="driver-header__left">
      <span id="org-short-name">RideOps</span>
      <span style="color:var(--color-text-muted); font-weight:400;">Driver</span>
    </div>
    <div class="driver-header__right">
      <span id="driver-name"></span>
      <button class="ro-btn ro-btn--outline ro-btn--sm" onclick="logout()"><i class="ti ti-logout"></i></button>
    </div>
  </header>

  <main class="driver-main">
    <div class="tab-panel active" id="home-panel">
      <div id="home-content"></div>
    </div>
    <div class="tab-panel" id="rides-panel">
      <div id="rides-content"></div>
    </div>
    <div class="tab-panel" id="account-panel">
      <div style="margin-bottom:24px;">
        <h3 style="font-size:16px; font-weight:700; margin:0 0 16px;">Profile</h3>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-name">Full Name</label>
          <input type="text" id="profile-name" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-phone">Phone</label>
          <input type="tel" id="profile-phone" class="ro-input">
        </div>
        <button class="ro-btn ro-btn--primary ro-btn--full" onclick="saveProfile()" style="margin-bottom:16px;">Save Changes</button>
        <div id="profile-message" style="font-size:13px; margin-bottom:16px;"></div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-uscid">USC ID</label>
          <input type="text" id="profile-uscid" class="ro-input" readonly style="background:var(--color-surface-hover); color:var(--color-text-muted);">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-email">Email</label>
          <input type="email" id="profile-email" class="ro-input" readonly style="background:var(--color-surface-hover); color:var(--color-text-muted);">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-username">Username</label>
          <input type="text" id="profile-username" class="ro-input" readonly style="background:var(--color-surface-hover); color:var(--color-text-muted);">
        </div>
      </div>
      <div style="border-top:1px solid var(--color-border); padding-top:20px;">
        <h3 style="font-size:16px; font-weight:700; margin:0 0 16px;">Change Password</h3>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="pw-current">Current Password</label>
          <input type="password" id="pw-current" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="pw-new">New Password (min 8 chars)</label>
          <input type="password" id="pw-new" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="pw-confirm">Confirm New Password</label>
          <input type="password" id="pw-confirm" class="ro-input">
        </div>
        <button class="ro-btn ro-btn--outline ro-btn--full" onclick="changePassword()">Update Password</button>
        <div id="pw-message" style="font-size:13px; margin-top:8px;"></div>
      </div>
    </div>
  </main>

  <nav class="ro-bottom-tabs">
    <button class="ro-bottom-tab active" data-target="home-panel"><i class="ti ti-home"></i>Home</button>
    <button class="ro-bottom-tab" data-target="rides-panel"><i class="ti ti-road"></i>My Rides</button>
    <button class="ro-bottom-tab" data-target="account-panel"><i class="ti ti-user"></i>Account</button>
  </nav>

  <script>
    let currentUser = null;
    let employees = [];
    let rides = [];
    let vehicles = [];

    const ACTIVE_STATUSES = ['driver_on_the_way', 'driver_arrived_grace'];
    const ASSIGNED_OPEN_STATUSES = ['scheduled', 'driver_on_the_way', 'driver_arrived_grace'];

    function todayLocal() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function pluralize(count, word) {
      return `${word}${count === 1 ? '' : 's'}`;
    }

    function getUrgencyInfo(ride) {
      if (!ride.requestedTime || ['completed', 'no_show'].includes(ride.status)) return '';
      const diffMs = new Date(ride.requestedTime).getTime() - Date.now();
      const diffMin = Math.round(diffMs / 60000);
      if (diffMin >= 0 && diffMin <= 15) {
        return `<span style="color:var(--status-no-show); font-weight:700; font-size:11px;"><i class="ti ti-clock" style="font-size:13px; vertical-align:middle;"></i> In ${diffMin} min</span>`;
      } else if (diffMin > 15 && diffMin <= 30) {
        return `<span style="color:var(--status-on-the-way); font-weight:700; font-size:11px;"><i class="ti ti-clock" style="font-size:13px; vertical-align:middle;"></i> In ${diffMin} min</span>`;
      }
      return '';
    }

    function renderVehicleSelector() {
      const opts = vehicles.filter(v => v.status === 'available').map(v =>
        `<option value="${v.id}">${v.name}</option>`
      ).join('');
      return `<select id="active-vehicle" class="ro-select" style="margin-bottom:12px;"><option value="">Select cart...</option>${opts}</select>`;
    }

    function renderAvailableRide(ride) {
      const time = formatTime(ride.requestedTime);
      const urgency = getUrgencyInfo(ride);
      return `<div class="strip-row" style="flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; flex:1; min-width:0;">
          <span class="fw-700 text-sm">${time}</span>
          ${urgency}
        </div>
        <div style="flex:1; min-width:0;">
          <div class="fw-600 text-sm" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ride.pickupLocation} → ${ride.dropoffLocation}</div>
          <div class="text-xs text-muted">${ride.riderName}</div>
        </div>
        <button class="ro-btn ro-btn--primary ro-btn--sm" onclick="claim('${ride.id}')">CLAIM</button>
      </div>`;
    }

    function renderActiveRide(ride) {
      const vehicleName = ride.vehicleId ? (vehicles.find(v => v.id === ride.vehicleId)?.name || '') : '';
      const phone = ride.riderPhone || '';
      const phoneLine = phone
        ? `<a href="tel:${phone}" style="color:var(--color-primary); font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:4px;"><i class="ti ti-phone" style="font-size:16px;"></i> ${phone}</a>`
        : '';

      let cta = '';
      if (ride.status === 'scheduled') {
        const vehOpts = vehicles.filter(v => v.status === 'available').map(v =>
          `<option value="${v.id}" ${v.id === ride.vehicleId ? 'selected' : ''}>${v.name}</option>`
        ).join('');
        const hasVehicle = !!ride.vehicleId;
        cta = `<select id="ride-vehicle-${ride.id}" class="ro-select" style="margin-bottom:12px;" onchange="setVehicle('${ride.id}', this.value)">
          <option value="">${hasVehicle ? 'Change cart...' : 'Select cart...'}</option>${vehOpts}
        </select>
        <button class="ro-btn ro-btn--primary ro-btn--action ro-btn--full" onclick="startRide('${ride.id}')"><i class="ti ti-navigation"></i> ON MY WAY</button>`;
      } else if (ride.status === 'driver_on_the_way') {
        cta = `<button class="ro-btn ro-btn--primary ro-btn--action ro-btn--full" onclick="action('${ride.id}','here')"><i class="ti ti-map-pin"></i> I'M HERE</button>`;
      } else if (ride.status === 'driver_arrived_grace') {
        const graceData = ride.graceStartTime ? ` data-grace="${ride.graceStartTime}"` : '';
        const elapsed = ride.graceStartTime ? (Date.now() - new Date(ride.graceStartTime).getTime()) / 1000 : 0;
        const remaining = Math.max(0, 300 - elapsed);
        const circumference = 452.4;
        const offset = circumference * (1 - remaining / 300);
        const mins = Math.floor(remaining / 60);
        const secs = Math.floor(remaining % 60);
        const timeStr = `${mins}:${String(secs).padStart(2, '0')}`;
        const expired = remaining <= 0;
        const canNoShow = expired;
        cta = `<div class="grace-timer${expired ? ' expired' : ''}"${graceData}>
          <div class="grace-timer__circle">
            <svg viewBox="0 0 160 160"><circle class="bg" cx="80" cy="80" r="72"/><circle class="progress" cx="80" cy="80" r="72" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/></svg>
            <div class="grace-timer__time">${timeStr}</div>
          </div>
          <div class="grace-timer__label">Waiting for rider</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="ro-btn ro-btn--success ro-btn--action" style="flex:1;" onclick="action('${ride.id}','complete')"><i class="ti ti-check"></i> RIDER BOARDED</button>
          <button class="ro-btn ro-btn--danger ro-btn--action" style="flex:1;" onclick="action('${ride.id}','no-show')" ${canNoShow ? '' : 'disabled'}><i class="ti ti-user-off"></i> NO SHOW</button>
        </div>`;
      }

      return `<div style="background:var(--color-surface); border:1px solid var(--color-border); border-radius:var(--radius-lg); padding:20px; margin-bottom:16px;">
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          ${ride.status === 'driver_arrived_grace' ? '<span class="status-badge status-badge--driver_arrived_grace">5-min grace period</span>' : statusBadge(ride.status)}
          <span class="text-xs text-muted">${formatTime(ride.requestedTime)}</span>
        </div>
        <div class="fw-700" style="font-size:16px; margin-bottom:4px;">${ride.riderName}</div>
        <div class="text-sm" style="margin-bottom:8px; color:var(--color-text-secondary);">
          <i class="ti ti-map-pin" style="font-size:14px; vertical-align:middle;"></i>
          ${ride.pickupLocation} → ${ride.dropoffLocation}
        </div>
        ${phoneLine ? `<div style="margin-bottom:8px;">${phoneLine}</div>` : ''}
        ${vehicleName ? `<div class="text-sm text-muted" style="margin-bottom:8px;"><i class="ti ti-car" style="font-size:14px; vertical-align:middle;"></i> ${vehicleName}</div>` : ''}
        ${ride.notes ? `<div class="text-xs text-muted" style="margin-bottom:12px;"><i class="ti ti-note" style="font-size:14px; vertical-align:middle;"></i> ${ride.notes}</div>` : ''}
        <div style="margin-top:16px;">${cta}</div>
      </div>`;
    }

    function renderFutureRide(ride) {
      return `<div class="strip-row">
        <span class="fw-700 text-sm">${formatTime(ride.requestedTime)}</span>
        <span class="text-sm" style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${ride.riderName} — ${ride.pickupLocation} → ${ride.dropoffLocation}</span>
      </div>`;
    }

    function renderCompletedRide(ride) {
      const isCompleted = ride.status === 'completed';
      const icon = isCompleted ? 'ti-circle-check' : 'ti-alert-circle';
      const color = isCompleted ? 'var(--status-completed)' : 'var(--status-no-show)';
      const label = isCompleted ? 'Completed' : 'No-Show';
      return `<div style="display:flex; align-items:center; gap:8px; padding:8px 0; font-size:13px;">
        <i class="ti ${icon}" style="font-size:16px; color:${color};"></i>
        <span class="fw-600">${formatTime(ride.requestedTime)}</span>
        <span class="text-muted" style="flex:1;">${ride.riderName}</span>
        <span class="text-xs" style="color:${color};">${label}</span>
      </div>`;
    }

    function renderHomePanel(isActive, today) {
      if (!isActive) {
        return `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:80px 24px; text-align:center;">
          <i class="ti ti-plug-off" style="font-size:48px; color:var(--color-text-muted); margin-bottom:16px;"></i>
          <div class="fw-700" style="font-size:18px; margin-bottom:8px;">You're Clocked Out</div>
          <button class="ro-btn ro-btn--primary ro-btn--action ro-btn--full" onclick="toggleClock()" style="max-width:320px; margin-bottom:12px;"><i class="ti ti-plug"></i> CLOCK IN</button>
          <div class="text-sm text-muted">Clock in to see available rides</div>
        </div>`;
      }

      const availableRides = rides.filter(r => r.status === 'approved' && !r.assignedDriverId && r.requestedTime?.startsWith(today));

      let ridesList = '';
      if (availableRides.length === 0) {
        ridesList = `<div class="ro-empty" style="padding:32px 16px;">
          <i class="ti ti-inbox"></i>
          <div class="ro-empty__title">No rides available</div>
          <div class="ro-empty__message">Approved rides with no assigned driver will show up here.</div>
        </div>`;
      } else {
        ridesList = `<div class="strip-list">${availableRides.map(renderAvailableRide).join('')}</div>`;
      }

      return `<div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
        <span style="width:10px; height:10px; border-radius:50%; background:var(--status-completed); display:inline-block;"></span>
        <span class="fw-700" style="font-size:14px;">You're Online</span>
      </div>
      ${renderVehicleSelector()}
      <button class="ro-btn ro-btn--outline ro-btn--action ro-btn--full" onclick="toggleClock()" style="margin-bottom:24px;"><i class="ti ti-plug-off"></i> CLOCK OUT</button>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <span class="fw-700" style="font-size:15px;">Available Rides</span>
        <span class="text-xs text-muted">${availableRides.length} ${pluralize(availableRides.length, 'ride')}</span>
      </div>
      ${ridesList}`;
    }

    function renderRidesPanel(today) {
      const actionableStatuses = ['scheduled', 'driver_on_the_way', 'driver_arrived_grace'];
      const doneStatuses = ['completed', 'no_show'];

      const myActive = rides.filter(r =>
        r.assignedDriverId === currentUser.id &&
        r.requestedTime?.startsWith(today) &&
        actionableStatuses.includes(r.status)
      );
      const myDone = rides.filter(r =>
        r.assignedDriverId === currentUser.id &&
        r.requestedTime?.startsWith(today) &&
        doneStatuses.includes(r.status)
      );

      // Active ride hero (pick the most urgent one)
      const activeRide = myActive.find(r => r.status === 'driver_arrived_grace')
        || myActive.find(r => r.status === 'driver_on_the_way')
        || myActive.find(r => r.status === 'scheduled');

      let heroHtml = '';
      if (activeRide) {
        heroHtml = renderActiveRide(activeRide);
      }

      // Upcoming: remaining active rides that aren't the hero
      const upcoming = myActive.filter(r => r.id !== activeRide?.id);
      let upcomingHtml = '';
      if (upcoming.length > 0) {
        upcomingHtml = `<div style="margin-bottom:16px;">
          <div class="fw-700 text-sm" style="margin-bottom:8px;">Upcoming</div>
          <div class="strip-list">${upcoming.map(renderFutureRide).join('')}</div>
        </div>`;
      }

      // Completed
      let doneHtml = '';
      if (myDone.length > 0) {
        doneHtml = `<div style="margin-bottom:16px;">
          <div class="fw-700 text-sm" style="margin-bottom:8px;">Completed</div>
          ${myDone.map(renderCompletedRide).join('')}
        </div>`;
      }

      if (!activeRide && upcoming.length === 0 && myDone.length === 0) {
        return `<div class="ro-empty" style="padding:48px 16px;">
          <i class="ti ti-road"></i>
          <div class="ro-empty__title">No rides today</div>
          <div class="ro-empty__message">Your assigned rides will appear here.</div>
        </div>`;
      }

      return heroHtml + upcomingHtml + doneHtml;
    }

    function render() {
      const savedVehicle = document.getElementById('active-vehicle')?.value || '';

      const me = employees.find(e => e.id === currentUser.id);
      const isActive = me?.active || false;
      const today = todayLocal();

      document.getElementById('home-content').innerHTML = renderHomePanel(isActive, today);
      document.getElementById('rides-content').innerHTML = renderRidesPanel(today);

      // Restore vehicle selection
      const vehEl = document.getElementById('active-vehicle');
      if (vehEl && savedVehicle) vehEl.value = savedVehicle;
    }

    function updateGraceTimers() {
      document.querySelectorAll('.grace-timer[data-grace]').forEach(el => {
        const elapsed = (Date.now() - new Date(el.dataset.grace).getTime()) / 1000;
        const remaining = Math.max(0, 300 - elapsed);
        const circumference = 452.4;
        const offset = circumference * (1 - remaining / 300);

        const progressCircle = el.querySelector('circle.progress');
        const timeText = el.querySelector('.grace-timer__time');
        const label = el.querySelector('.grace-timer__label');

        if (progressCircle) {
          progressCircle.style.strokeDashoffset = offset;
          if (remaining <= 0) {
            progressCircle.style.stroke = 'var(--status-no-show)';
          }
        }
        if (timeText) {
          const mins = Math.floor(remaining / 60);
          const secs = Math.floor(remaining % 60);
          timeText.textContent = `${mins}:${String(secs).padStart(2, '0')}`;
        }
        if (label) {
          label.textContent = remaining <= 0 ? 'Grace period expired' : 'Waiting for rider';
        }

        // Enable no-show button when timer expires
        if (remaining <= 0) {
          const card = el.closest('[style]');
          if (card) {
            const noShowBtn = card.querySelector('.ro-btn--danger[disabled]');
            if (noShowBtn) noShowBtn.disabled = false;
          }
        }
      });
    }

    async function init() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) { window.location.href = '/login'; return; }
        currentUser = await res.json();
        document.getElementById('driver-name').textContent = currentUser.name;
        applyTenantTheme();
        initBottomTabs();
        await loadProfile();
        await loadData();
        setInterval(loadData, 3000);
        setInterval(updateGraceTimers, 1000);
      } catch {
        window.location.href = '/login';
      }
    }

    async function loadData() {
      try {
        const [empRes, ridesRes, vehRes] = await Promise.all([
          fetch('/api/employees'),
          fetch('/api/rides'),
          fetch('/api/vehicles')
        ]);
        employees = await empRes.json();
        rides = await ridesRes.json();
        vehicles = await vehRes.json();
        render();
      } catch (e) {
        console.warn('Failed to load data:', e);
      }
    }

    async function loadProfile() {
      try {
        const res = await fetch('/api/me');
        const me = await res.json();
        document.getElementById('profile-uscid').value = me.usc_id || '';
        document.getElementById('profile-email').value = me.email || '';
        document.getElementById('profile-username').value = me.username || '';
        document.getElementById('profile-name').value = me.name || '';
        document.getElementById('profile-phone').value = me.phone || '';
      } catch {}
    }

    async function saveProfile() {
      const msg = document.getElementById('profile-message');
      msg.textContent = '';
      const name = document.getElementById('profile-name').value.trim();
      const phone = document.getElementById('profile-phone').value.trim();
      const res = await fetch('/api/me', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, phone })
      });
      const data = await res.json();
      if (!res.ok) {
        msg.textContent = data.error || 'Could not save profile';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      msg.textContent = 'Saved!';
      msg.style.color = 'var(--status-completed)';
      document.getElementById('driver-name').textContent = data.name;
      showToastNew('Profile updated', 'success');
    }

    async function changePassword() {
      const msg = document.getElementById('pw-message');
      msg.textContent = '';
      msg.style.color = '';
      const currentPassword = document.getElementById('pw-current').value;
      const newPassword = document.getElementById('pw-new').value;
      const confirm = document.getElementById('pw-confirm').value;
      if (!currentPassword || !newPassword || !confirm) {
        msg.textContent = 'All fields are required.';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      if (newPassword.length < 8) {
        msg.textContent = 'New password must be at least 8 characters.';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      if (newPassword !== confirm) {
        msg.textContent = 'Passwords do not match.';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      try {
        const res = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const data = await res.json();
        if (!res.ok) {
          msg.textContent = data.error || 'Failed to change password';
          msg.style.color = 'var(--status-no-show)';
          return;
        }
        msg.textContent = 'Password updated successfully!';
        msg.style.color = 'var(--status-completed)';
        document.getElementById('pw-current').value = '';
        document.getElementById('pw-new').value = '';
        document.getElementById('pw-confirm').value = '';
        showToastNew('Password changed', 'success');
      } catch {
        msg.textContent = 'Connection error';
        msg.style.color = 'var(--status-no-show)';
      }
    }

    async function toggleClock() {
      const me = employees.find(e => e.id === currentUser.id);
      if (!me) return;

      if (me.active) {
        const activeRideCount = rides.filter(r => r.assignedDriverId === currentUser.id && ACTIVE_STATUSES.includes(r.status)).length;
        const assignedRideCount = rides.filter(r => r.assignedDriverId === currentUser.id && ASSIGNED_OPEN_STATUSES.includes(r.status)).length;
        let message = 'Are you sure you want to clock out?';
        if (activeRideCount > 0) {
          message = `You have ${activeRideCount} active ${pluralize(activeRideCount, 'ride')}. Clock out anyway?`;
        } else if (assignedRideCount > 0) {
          message = `You still have ${assignedRideCount} assigned ${pluralize(assignedRideCount, 'ride')}. Clock out anyway?`;
        }
        showModalNew({
          title: 'Clock Out',
          body: message,
          confirmLabel: 'Clock Out',
          confirmClass: 'ro-btn--danger',
          onConfirm: () => doClockToggle(me)
        });
        return;
      }

      doClockToggle(me);
    }

    async function doClockToggle(me) {
      const endpoint = me.active ? 'clock-out' : 'clock-in';
      const response = await fetch(`/api/employees/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employeeId: currentUser.id })
      });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Could not update clock status', 'error');
        return;
      }
      showToastNew(me.active ? 'Clocked out' : 'Clocked in', 'success');
      await loadData();
    }

    async function claim(id) {
      const vehSelect = document.getElementById('active-vehicle');
      const vehicleId = vehSelect?.value || null;
      const body = vehicleId ? JSON.stringify({ vehicleId }) : '{}';
      const response = await fetch(`/api/rides/${id}/claim`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body
      });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Failed to claim ride', 'error');
      } else {
        showToastNew('Ride claimed successfully', 'success');
      }
      await loadData();
    }

    async function action(id, act) {
      if (act === 'complete') {
        showModalNew({
          title: 'Complete Ride',
          body: 'Mark this ride as completed?',
          confirmLabel: 'Complete',
          confirmClass: 'ro-btn--success',
          onConfirm: () => doAction(id, act)
        });
        return;
      }
      if (act === 'no-show') {
        showModalNew({
          title: 'Confirm No-Show',
          body: 'Mark this rider as a no-show? This increases their no-show count.',
          confirmLabel: 'Mark No-Show',
          confirmClass: 'ro-btn--danger',
          onConfirm: () => doAction(id, act)
        });
        return;
      }
      doAction(id, act);
    }

    async function doAction(id, act) {
      const response = await fetch(`/api/rides/${id}/${act}`, { method: 'POST' });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Action failed', 'error');
      } else {
        const messages = {
          'on-the-way': 'Marked as on the way',
          here: 'Marked as arrived — grace timer started',
          complete: 'Ride completed',
          'no-show': 'Marked as no-show'
        };
        showToastNew(messages[act] || 'Action completed', 'success');
      }
      await loadData();
    }

    async function startRide(id) {
      const selectEl = document.getElementById(`ride-vehicle-${id}`);
      const ride = rides.find(r => r.id === id);
      const vehicleId = selectEl?.value || ride?.vehicleId || null;
      if (!vehicleId) {
        showToastNew('Please select a cart before starting this ride', 'error');
        if (selectEl) selectEl.focus();
        return;
      }
      const response = await fetch(`/api/rides/${id}/on-the-way`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicleId })
      });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Could not start ride', 'error');
      } else {
        showToastNew('Marked as on the way', 'success');
      }
      await loadData();
    }

    async function setVehicle(rideId, vehicleId) {
      if (!vehicleId) return;
      const response = await fetch(`/api/rides/${rideId}/set-vehicle`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ vehicleId })
      });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Could not set vehicle', 'error');
      } else {
        const veh = vehicles.find(v => v.id === vehicleId);
        showToastNew(`Vehicle set to ${veh?.name || 'cart'}`, 'success');
      }
      await loadData();
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    init();
  </script>
</body>
</html>
