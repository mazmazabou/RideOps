<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Console</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.2.0/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.37.1/dist/tabler-icons.min.css">
  <link rel="stylesheet" href="/css/rideops-theme.css">
  <script src="/js/rideops-utils.js"></script>
  <script src="/campus-themes.js"></script>
  <script>
    // Synchronous FOUC prevention: apply campus colors before first paint
    (function() {
      var parts = window.location.pathname.split('/').filter(Boolean);
      var slug = ['usc','stanford','ucla','uci'].indexOf(parts[0]) !== -1 ? parts[0] : null;
      if (slug && typeof CAMPUS_THEMES !== 'undefined' && CAMPUS_THEMES[slug]) {
        var ct = CAMPUS_THEMES[slug];
        var root = document.documentElement;
        root.style.setProperty('--color-primary', ct.primaryColor);
        root.style.setProperty('--color-primary-rgb', hexToRgb(ct.primaryColor));
        if (ct.headerBg) root.style.setProperty('--color-header-bg', ct.headerBg);
      }
    })();
  </script>
  <script src="/demo-config.js"></script>
  <style>
    body { background: rgba(var(--color-primary-rgb, 70,130,180), 0.03); }
    .driver-header { position: sticky; top: 0; z-index: 20; height: 48px; background: var(--color-primary); border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; color: #fff; }
    .driver-header__left { display: flex; align-items: center; gap: 8px; }
    .driver-header__left span { font-weight: 700; font-size: 14px; color: #fff; }
    .driver-header__right { display: flex; align-items: center; gap: 10px; }
    .driver-header__right #driver-name { font-size: 13px; color: rgba(255,255,255,0.85); }
    .driver-header .notif-bell { color: #fff; }
    .driver-header .ro-btn--outline { color: #fff; border-color: rgba(255,255,255,0.5); }
    .driver-header .ro-btn--outline:hover { background: rgba(255,255,255,0.15); }
    .driver-main { max-width: 600px; margin: 0 auto; padding: 16px; }
    .active-ride-card { border-left: 4px solid var(--color-primary); border-radius: 0 var(--radius-lg) var(--radius-lg) 0; }
    .grace-timer__circle circle.progress { stroke: var(--color-primary) !important; }
  </style>
</head>
<body style="padding-bottom:56px;">
  <header class="driver-header">
    <div class="driver-header__left">
      <span id="org-short-name">RideOps</span>
      <span style="color:var(--color-text-muted); font-weight:400;">Driver</span>
    </div>
    <div class="driver-header__right">
      <button class="notif-bell" id="notif-bell-btn" title="Notifications">
        <i class="ti ti-bell"></i>
        <span class="notif-badge" id="notif-badge"></span>
      </button>
      <span id="driver-name"></span>
      <button class="ro-btn ro-btn--outline ro-btn--sm" onclick="logout()"><i class="ti ti-logout"></i></button>
    </div>
  </header>

  <main class="driver-main">
    <div class="tab-panel active" id="home-panel">
      <div id="home-content"></div>
    </div>
    <div class="tab-panel" id="rides-panel">
      <div id="rides-content"></div>
    </div>
    <div class="tab-panel" id="account-panel">
      <div style="margin-bottom:24px;">
        <h3 style="font-size:16px; font-weight:700; margin:0 0 16px;">Profile</h3>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-name">Full Name</label>
          <input type="text" id="profile-name" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-phone">Phone</label>
          <input type="tel" id="profile-phone" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-preferred-name">Preferred Name</label>
          <input type="text" id="profile-preferred-name" class="ro-input" placeholder="What should riders call you?" maxlength="50">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-major">Major</label>
          <input type="text" id="profile-major" class="ro-input" placeholder="e.g. Computer Science" maxlength="100">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-grad-year">Graduation Year</label>
          <select id="profile-grad-year" class="ro-input">
            <option value="">—</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
          </select>
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-bio">Bio</label>
          <input type="text" id="profile-bio" class="ro-input" placeholder="Quick note for your riders (120 chars)" maxlength="120">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label">Avatar</label>
          <div id="driver-avatar-picker-wrap"></div>
        </div>
        <button class="ro-btn ro-btn--primary ro-btn--full" onclick="saveProfile()" style="margin-bottom:16px;">Save Changes</button>
        <div id="profile-message" style="font-size:13px; margin-bottom:16px;"></div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-memberid" id="profile-memberid-label">Member ID</label>
          <input type="text" id="profile-memberid" class="ro-input" readonly style="background:var(--color-surface-hover); color:var(--color-text-muted);">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-email">Email</label>
          <input type="email" id="profile-email" class="ro-input" readonly style="background:var(--color-surface-hover); color:var(--color-text-muted);">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="profile-username">Username</label>
          <input type="text" id="profile-username" class="ro-input" readonly style="background:var(--color-surface-hover); color:var(--color-text-muted);">
        </div>
      </div>
      <div style="border-top:1px solid var(--color-border); padding-top:20px;">
        <h3 style="font-size:16px; font-weight:700; margin:0 0 16px;">Change Password</h3>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="pw-current">Current Password</label>
          <input type="password" id="pw-current" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="pw-new">New Password (min 8 chars)</label>
          <input type="password" id="pw-new" class="ro-input">
        </div>
        <div style="margin-bottom:12px;">
          <label class="ro-label" for="pw-confirm">Confirm New Password</label>
          <input type="password" id="pw-confirm" class="ro-input">
        </div>
        <button class="ro-btn ro-btn--outline ro-btn--full" onclick="changePassword()">Update Password</button>
        <div id="pw-message" style="font-size:13px; margin-top:8px;"></div>
      </div>
    </div>
    <div class="tab-panel" id="map-panel">
      <div id="map-content"></div>
    </div>
  </main>

  <nav class="ro-bottom-tabs">
    <button class="ro-bottom-tab active" data-target="home-panel"><i class="ti ti-home"></i>Home</button>
    <button class="ro-bottom-tab" data-target="rides-panel"><i class="ti ti-road"></i>My Rides</button>
    <button class="ro-bottom-tab" data-target="map-panel"><i class="ti ti-map-2"></i>Map</button>
    <button class="ro-bottom-tab" data-target="account-panel"><i class="ti ti-user"></i>Account</button>
  </nav>

  <script>
    let currentUser = null;
    let employees = [];
    let rides = [];
    let vehicles = [];
    let gracePeriodSeconds = 300;

    const ACTIVE_STATUSES = ['driver_on_the_way', 'driver_arrived_grace'];
    const ASSIGNED_OPEN_STATUSES = ['scheduled', 'driver_on_the_way', 'driver_arrived_grace'];

    function todayLocal() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function pluralize(count, word) {
      return `${word}${count === 1 ? '' : 's'}`;
    }

    function getUrgencyInfo(ride) {
      if (!ride.requestedTime || ['completed', 'no_show'].includes(ride.status)) return '';
      const diffMs = new Date(ride.requestedTime).getTime() - Date.now();
      const diffMin = Math.round(diffMs / 60000);
      if (diffMin >= 0 && diffMin <= 15) {
        return `<span style="color:var(--status-no-show); font-weight:700; font-size:11px;"><i class="ti ti-clock" style="font-size:13px; vertical-align:middle;"></i> In ${diffMin} min</span>`;
      } else if (diffMin > 15 && diffMin <= 30) {
        return `<span style="color:var(--status-on-the-way); font-weight:700; font-size:11px;"><i class="ti ti-clock" style="font-size:13px; vertical-align:middle;"></i> In ${diffMin} min</span>`;
      }
      return '';
    }

    function renderAvailableRide(ride) {
      const time = formatTime(ride.requestedTime);
      const urgency = getUrgencyInfo(ride);
      return `<div class="strip-row" style="flex-wrap:wrap; gap:8px;">
        <div style="display:flex; align-items:center; gap:8px; flex:1; min-width:0;">
          <span class="fw-700 text-sm">${time}</span>
          ${urgency}
        </div>
        <div style="flex:1; min-width:0;">
          <div class="fw-600 text-sm" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${ride.pickupLocation} → ${ride.dropoffLocation}</div>
          <div class="text-xs text-muted">${ride.riderName}</div>
        </div>
        <button class="ro-btn ro-btn--primary ro-btn--sm" onclick="claim('${ride.id}')">CLAIM</button>
      </div>`;
    }

    function renderActiveRide(ride) {
      const vehicleName = ride.vehicleId ? (vehicles.find(v => v.id === ride.vehicleId)?.name || '') : '';
      const phone = ride.riderPhone || '';
      const phoneLine = phone
        ? `<a href="tel:${phone}" style="color:var(--color-primary); font-size:13px; text-decoration:none; display:inline-flex; align-items:center; gap:4px;"><i class="ti ti-phone" style="font-size:16px;"></i> ${phone}</a>`
        : '';

      let cta = '';
      if (ride.status === 'scheduled') {
        cta = `<button class="ro-btn ro-btn--primary ro-btn--action ro-btn--full" onclick="startRide('${ride.id}')"><i class="ti ti-navigation"></i> ON MY WAY</button>`;
      } else if (ride.status === 'driver_on_the_way') {
        cta = `<button class="ro-btn ro-btn--primary ro-btn--action ro-btn--full" onclick="action('${ride.id}','here')"><i class="ti ti-map-pin"></i> I'M HERE</button>`;
      } else if (ride.status === 'driver_arrived_grace') {
        const graceData = ride.graceStartTime ? ` data-grace="${ride.graceStartTime}"` : '';
        const elapsed = ride.graceStartTime ? (Date.now() - new Date(ride.graceStartTime).getTime()) / 1000 : 0;
        const remaining = Math.max(0, gracePeriodSeconds - elapsed);
        const circumference = 452.4;
        const offset = circumference * (1 - remaining / gracePeriodSeconds);
        const mins = Math.floor(remaining / 60);
        const secs = Math.floor(remaining % 60);
        const timeStr = `${mins}:${String(secs).padStart(2, '0')}`;
        const expired = remaining <= 0;
        const canNoShow = expired;
        cta = `<div class="grace-timer${expired ? ' expired' : ''}"${graceData}>
          <div class="grace-timer__circle">
            <svg viewBox="0 0 160 160"><circle class="bg" cx="80" cy="80" r="72"/><circle class="progress" cx="80" cy="80" r="72" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/></svg>
            <div class="grace-timer__time">${timeStr}</div>
          </div>
          <div class="grace-timer__label">Waiting for rider</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="ro-btn ro-btn--success ro-btn--action" style="flex:1;" onclick="action('${ride.id}','complete')"><i class="ti ti-check"></i> RIDER BOARDED</button>
          <button class="ro-btn ro-btn--danger ro-btn--action" style="flex:1;" onclick="action('${ride.id}','no-show')" ${canNoShow ? '' : 'disabled'}><i class="ti ti-user-off"></i> NO SHOW</button>
        </div>`;
      }

      return `<div class="active-ride-card" style="background:var(--color-surface); border:1px solid var(--color-border); padding:20px; margin-bottom:16px;" data-ride-id="${ride.id}">
        <div id="vehicle-required-banner-slot"></div>
        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
          ${ride.status === 'driver_arrived_grace' ? '<span class="status-badge status-badge--driver_arrived_grace">Grace Period</span>' : statusBadge(ride.status)}
          <span class="text-xs text-muted">${formatTime(ride.requestedTime)}</span>
        </div>
        ${profileCardHTML({
          name: ride.riderName,
          preferredName: ride.riderPreferredName,
          avatarUrl: ride.riderAvatar,
          major: ride.riderMajor,
          graduationYear: ride.riderGraduationYear,
          bio: ride.riderBio
        }, { variant: 'compact' })}
        <div class="text-sm" style="margin: 8px 0; color:var(--color-text-secondary);">
          <i class="ti ti-map-pin" style="font-size:14px; vertical-align:middle;"></i>
          ${ride.pickupLocation} → ${ride.dropoffLocation}
        </div>
        ${phoneLine ? `<div style="margin-bottom:8px;">${phoneLine}</div>` : ''}
        ${ride.notes ? `<div class="text-xs text-muted" style="margin-bottom:12px;"><i class="ti ti-note" style="font-size:14px; vertical-align:middle;"></i> ${ride.notes}</div>` : ''}
        ${ride.vehicleId
          ? `<div style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--color-text-muted);margin-top:8px;margin-bottom:8px;">
              <i class="ti ti-car" style="color:var(--color-primary);"></i>
              <span>${vehicleName || 'Vehicle'}</span>
              <button onclick="showVehicleSelector('${ride.id}')" style="margin-left:auto;font-size:11px;color:var(--color-primary);background:none;border:none;cursor:pointer;text-decoration:underline;">Change</button>
            </div>`
          : `<div id="ride-vehicle-row" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--color-border);">
              <div style="font-size:12px; font-weight:600; color:var(--color-text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">
                <i class="ti ti-car"></i> Vehicle
              </div>
              <select id="ride-vehicle-select" onchange="assignVehicleToRide('${ride.id}', this.value)"
                style="width:100%; padding:10px 12px; border:1px solid var(--color-border);
                       border-radius:8px; font-size:14px; background:var(--color-surface);
                       color:var(--color-text); appearance:none;">
                <option value="">Select vehicle\u2026</option>
              </select>
            </div>`
        }
        <div style="margin-top:16px;">${cta}</div>
      </div>`;
    }

    function renderFutureRide(ride) {
      return `<div class="strip-row">
        <span class="fw-700 text-sm">${formatTime(ride.requestedTime)}</span>
        <span class="text-sm" style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${ride.riderName} — ${ride.pickupLocation} → ${ride.dropoffLocation}</span>
      </div>`;
    }

    function renderCompletedRide(ride) {
      const isCompleted = ride.status === 'completed';
      const icon = isCompleted ? 'ti-circle-check' : 'ti-alert-circle';
      const color = isCompleted ? 'var(--status-completed)' : 'var(--status-no-show)';
      const label = isCompleted ? 'Completed' : 'No-Show';
      return `<div style="display:flex; align-items:center; gap:8px; padding:8px 0; font-size:13px;">
        <i class="ti ${icon}" style="font-size:16px; color:${color};"></i>
        <span class="fw-600">${formatTime(ride.requestedTime)}</span>
        <span class="text-muted" style="flex:1;">${ride.riderName}</span>
        <span class="text-xs" style="color:${color};">${label}</span>
      </div>`;
    }

    function renderHomePanel(isActive, today) {
      if (!isActive) {
        return `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:80px 24px; text-align:center;">
          <i class="ti ti-plug-off" style="font-size:48px; color:var(--color-text-muted); margin-bottom:16px;"></i>
          <div class="fw-700" style="font-size:18px; margin-bottom:8px;">You're Clocked Out</div>
          <button class="ro-btn ro-btn--primary ro-btn--action ro-btn--full" onclick="toggleClock()" style="max-width:320px; margin-bottom:12px;"><i class="ti ti-plug"></i> CLOCK IN</button>
          <div class="text-sm text-muted">Clock in to see available rides</div>
        </div>`;
      }

      const availableRides = rides.filter(r => r.status === 'approved' && !r.assignedDriverId && r.requestedTime?.startsWith(today));

      let ridesList = '';
      if (availableRides.length === 0) {
        ridesList = `<div class="ro-empty" style="padding:32px 16px;">
          <i class="ti ti-inbox"></i>
          <div class="ro-empty__title">No rides available</div>
          <div class="ro-empty__message">Approved rides with no assigned driver will show up here.</div>
        </div>`;
      } else {
        ridesList = `<div class="strip-list">${availableRides.map(renderAvailableRide).join('')}</div>`;
      }

      return `<div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
        <span style="width:10px; height:10px; border-radius:50%; background:var(--status-completed); display:inline-block;"></span>
        <span class="fw-700" style="font-size:14px;">You're Online</span>
      </div>
      <button class="ro-btn ro-btn--action ro-btn--full" onclick="toggleClock()" style="background:transparent; color:var(--status-no-show); border:2px solid var(--status-no-show); margin-bottom:24px;"><i class="ti ti-plug-off"></i> CLOCK OUT</button>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
        <span class="fw-700" style="font-size:15px;">Available Rides</span>
        <span class="text-xs text-muted">${availableRides.length} ${pluralize(availableRides.length, 'ride')}</span>
      </div>
      ${ridesList}`;
    }

    function renderRidesPanel(today) {
      const actionableStatuses = ['scheduled', 'driver_on_the_way', 'driver_arrived_grace'];
      const doneStatuses = ['completed', 'no_show'];

      const myActive = rides.filter(r =>
        r.assignedDriverId === currentUser.id &&
        r.requestedTime?.startsWith(today) &&
        actionableStatuses.includes(r.status)
      );
      const myDone = rides.filter(r =>
        r.assignedDriverId === currentUser.id &&
        r.requestedTime?.startsWith(today) &&
        doneStatuses.includes(r.status)
      );

      // Active ride hero (pick the most urgent one)
      const activeRide = myActive.find(r => r.status === 'driver_arrived_grace')
        || myActive.find(r => r.status === 'driver_on_the_way')
        || myActive.find(r => r.status === 'scheduled');

      let heroHtml = '';
      if (activeRide) {
        heroHtml = renderActiveRide(activeRide);
      }

      // Upcoming: remaining active rides that aren't the hero
      const upcoming = myActive.filter(r => r.id !== activeRide?.id);
      let upcomingHtml = '';
      if (upcoming.length > 0) {
        upcomingHtml = `<div style="margin-bottom:16px;">
          <div class="fw-700 text-sm" style="margin-bottom:8px;">Upcoming</div>
          <div class="strip-list">${upcoming.map(renderFutureRide).join('')}</div>
        </div>`;
      }

      // Completed
      let doneHtml = '';
      if (myDone.length > 0) {
        doneHtml = `<div style="margin-bottom:16px;">
          <div class="fw-700 text-sm" style="margin-bottom:8px;">Completed</div>
          ${myDone.map(renderCompletedRide).join('')}
        </div>`;
      }

      if (!activeRide && upcoming.length === 0 && myDone.length === 0) {
        return `<div class="ro-empty" style="padding:48px 16px;">
          <i class="ti ti-road"></i>
          <div class="ro-empty__title">No rides today</div>
          <div class="ro-empty__message">Your assigned rides will appear here.</div>
        </div>`;
      }

      return heroHtml + upcomingHtml + doneHtml;
    }

    function getActiveRide() {
      const today = todayLocal();
      const myActive = rides.filter(r =>
        r.assignedDriverId === currentUser.id &&
        r.requestedTime?.startsWith(today) &&
        ['scheduled', 'driver_on_the_way', 'driver_arrived_grace'].includes(r.status)
      );
      return myActive.find(r => r.status === 'driver_arrived_grace')
        || myActive.find(r => r.status === 'driver_on_the_way')
        || myActive.find(r => r.status === 'scheduled')
        || null;
    }

    function renderMapTab() {
      const panel = document.getElementById('map-content');
      if (!panel) return;
      const activeRide = getActiveRide();
      const campusMapUrl = (window.tenantConfig && window.tenantConfig.mapUrl) || null;
      if (!activeRide) {
        panel.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;gap:16px;color:var(--color-text-muted);text-align:center;padding:24px;">
            <i class="ti ti-map-off" style="font-size:48px;opacity:0.3;"></i>
            <div style="font-size:15px;font-weight:500;">No active ride</div>
            <div style="font-size:13px;">Map navigation appears here when you have an active ride.</div>
          </div>`;
        return;
      }
      const pickup = activeRide.pickupLocation || '';
      const dropoff = activeRide.dropoffLocation || '';
      const riderName = activeRide.riderName || 'Rider';
      const mapHref = campusMapUrl || '#';
      panel.innerHTML = `
        <div style="padding:16px;display:flex;flex-direction:column;gap:16px;">
          <div style="background:var(--color-surface);border-radius:12px;padding:16px;border:1px solid var(--color-border);">
            <div style="font-size:12px;color:var(--color-text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Active Ride</div>
            <div style="font-weight:700;font-size:15px;margin-bottom:12px;">${riderName}</div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <div style="display:flex;align-items:flex-start;gap:8px;font-size:13px;">
                <i class="ti ti-circle-dot" style="color:var(--color-primary);margin-top:1px;flex-shrink:0;"></i>
                <span style="color:var(--color-text-muted);">From:</span>
                <span style="font-weight:500;">${pickup || 'Not specified'}</span>
              </div>
              <div style="display:flex;align-items:flex-start;gap:8px;font-size:13px;">
                <i class="ti ti-map-pin" style="color:var(--color-primary);margin-top:1px;flex-shrink:0;"></i>
                <span style="color:var(--color-text-muted);">To:</span>
                <span style="font-weight:500;">${dropoff || 'Not specified'}</span>
              </div>
            </div>
          </div>
          ${campusMapUrl ? `
          <a href="${mapHref}" target="_blank" rel="noopener"
             style="display:flex;align-items:center;justify-content:center;gap:10px;
                    background:var(--color-primary);color:white;
                    padding:16px;border-radius:12px;text-decoration:none;
                    font-weight:700;font-size:16px;letter-spacing:0.3px;
                    box-shadow:0 4px 12px rgba(var(--color-primary-rgb),0.35);">
            <i class="ti ti-map-2" style="font-size:20px;"></i>
            Open Campus Map
          </a>` : ''}
          ${campusMapUrl ? `
          <div style="border-radius:12px;overflow:hidden;border:1px solid var(--color-border);height:380px;">
            <iframe
              src="${campusMapUrl}"
              width="100%" height="380" style="border:0;display:block;"
              allowfullscreen loading="lazy"
              title="Campus Map">
            </iframe>
          </div>
          <div style="font-size:11px;color:var(--color-text-muted);text-align:center;margin-top:-4px;">
            Campus map — use pinch/zoom to navigate
          </div>` : ''}
        </div>`;
    }

    function populateVehicleDropdown() {
      const sel = document.getElementById('ride-vehicle-select');
      if (!sel) return;
      const available = vehicles.filter(v => v.status !== 'retired');
      available.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = v.name + (v.type === 'accessible' ? ' (Accessible)' : '');
        sel.appendChild(opt);
      });
    }

    let _vehicleWarningShown = false;

    async function assignVehicleToRide(rideId, vehicleId) {
      if (!vehicleId) return;
      try {
        const res = await fetch('/api/rides/' + rideId + '/vehicle', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ vehicle_id: vehicleId })
        });
        if (!res.ok) {
          const errBody = await res.text();
          console.error('Vehicle PATCH failed:', res.status, errBody);
          try { var err = JSON.parse(errBody); } catch(_) { var err = {}; }
          showToastNew(err.error || 'Failed to record vehicle', 'error');
          return;
        }
        _vehicleWarningShown = false;
        showToastNew('Vehicle recorded', 'success');
        await loadData();
      } catch (e) {
        showToastNew('Failed to record vehicle \u2014 try again', 'error');
      }
    }

    function showVehicleSelector(rideId) {
      const card = document.querySelector('.active-ride-card[data-ride-id="' + rideId + '"]');
      if (!card) return;
      const confirmedRow = card.querySelector('[style*="margin-left:auto"]')?.closest('div');
      if (confirmedRow) {
        const available = vehicles.filter(v => v.status !== 'retired');
        let opts = '<option value="">Select vehicle\u2026</option>';
        available.forEach(v => {
          opts += '<option value="' + v.id + '">' + v.name + (v.type === 'accessible' ? ' (Accessible)' : '') + '</option>';
        });
        confirmedRow.outerHTML = `<div id="ride-vehicle-row" style="margin-top:12px; padding-top:12px; border-top:1px solid var(--color-border);">
          <div style="font-size:12px; font-weight:600; color:var(--color-text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">
            <i class="ti ti-car"></i> Vehicle
          </div>
          <select id="ride-vehicle-select" onchange="assignVehicleToRide('${rideId}', this.value)"
            style="width:100%; padding:10px 12px; border:1px solid var(--color-border);
                   border-radius:8px; font-size:14px; background:var(--color-surface);
                   color:var(--color-text); appearance:none;">
            ${opts}
          </select>
        </div>`;
      }
    }

    function showVehicleWarningBanner() {
      const slot = document.getElementById('vehicle-required-banner-slot');
      if (slot && !slot.hasChildNodes()) {
        slot.innerHTML = `<div style="
          background:rgba(255,193,7,0.12);
          border:1px solid rgba(255,193,7,0.4);
          border-radius:8px; padding:10px 14px;
          display:flex; align-items:center; gap:10px; margin-bottom:12px;">
          <i class="ti ti-alert-triangle" style="color:#d97706;flex-shrink:0;"></i>
          <span style="font-size:13px;color:var(--color-text);">
            <strong>Select a vehicle</strong> in the section below before completing this ride.
          </span>
        </div>`;
      }
    }

    function render() {
      const me = employees.find(e => e.id === currentUser.id);
      const isActive = me?.active || false;
      const today = todayLocal();

      document.getElementById('home-content').innerHTML = renderHomePanel(isActive, today);
      document.getElementById('rides-content').innerHTML = renderRidesPanel(today);
      renderMapTab();
      populateVehicleDropdown();
    }

    function updateGraceTimers() {
      document.querySelectorAll('.grace-timer[data-grace]').forEach(el => {
        const elapsed = (Date.now() - new Date(el.dataset.grace).getTime()) / 1000;
        const remaining = Math.max(0, gracePeriodSeconds - elapsed);
        const circumference = 452.4;
        const offset = circumference * (1 - remaining / gracePeriodSeconds);

        const progressCircle = el.querySelector('circle.progress');
        const timeText = el.querySelector('.grace-timer__time');
        const label = el.querySelector('.grace-timer__label');

        if (progressCircle) {
          progressCircle.style.strokeDashoffset = offset;
          if (remaining <= 0) {
            progressCircle.style.stroke = 'var(--status-no-show)';
          }
        }
        if (timeText) {
          const mins = Math.floor(remaining / 60);
          const secs = Math.floor(remaining % 60);
          timeText.textContent = `${mins}:${String(secs).padStart(2, '0')}`;
        }
        if (label) {
          label.textContent = remaining <= 0 ? 'Grace period expired' : 'Waiting for rider';
        }

        // Enable no-show button when timer expires
        if (remaining <= 0) {
          const card = el.closest('[style]');
          if (card) {
            const noShowBtn = card.querySelector('.ro-btn--danger[disabled]');
            if (noShowBtn) noShowBtn.disabled = false;
          }
        }
      });
    }

    async function init() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) { window.location.href = '/login'; return; }
        currentUser = await res.json();
        if (!currentUser.demoMode && currentUser.role !== 'driver') {
          window.location.href = currentUser.role === 'office' ? '/' : '/rider.html';
          return;
        }
        document.getElementById('driver-name').textContent = currentUser.name;
        window.tenantConfig = await applyTenantTheme() || {};
        initBottomTabs();
        initNotificationBell('#notif-bell-btn');
        try {
          const cfg = await getOpsConfig();
          gracePeriodSeconds = Number(cfg.grace_period_minutes || 5) * 60;
          window._opsGraceMins = Number(cfg.grace_period_minutes || 5);
        } catch(e) { console.warn('Failed to load ops config for grace period:', e); }
        await loadProfile();
        await loadData();
        window._pollIntervals = [
          setInterval(loadData, 3000),
          setInterval(updateGraceTimers, 1000)
        ];
      } catch {
        window.location.href = '/login';
      }
    }

    async function loadData() {
      try {
        const [empRes, ridesRes, vehRes] = await Promise.all([
          fetch('/api/employees'),
          fetch('/api/rides'),
          fetch('/api/vehicles')
        ]);
        employees = await empRes.json();
        rides = await ridesRes.json();
        vehicles = await vehRes.json();
        render();
      } catch (e) {
        console.warn('Failed to load data:', e);
        showToastNew('Unable to refresh data — check your connection', 'error');
      }
    }

    let _driverSelectedAvatarUrl = undefined;

    async function loadProfile() {
      try {
        const res = await fetch('/api/me');
        const me = await res.json();
        document.getElementById('profile-memberid').value = me.member_id || '';
        document.getElementById('profile-email').value = me.email || '';
        document.getElementById('profile-username').value = me.username || '';
        document.getElementById('profile-name').value = me.name || '';
        document.getElementById('profile-phone').value = me.phone || '';
        document.getElementById('profile-preferred-name').value = me.preferred_name || '';
        document.getElementById('profile-major').value = me.major || '';
        document.getElementById('profile-grad-year').value = me.graduation_year || '';
        document.getElementById('profile-bio').value = me.bio || '';
        _driverSelectedAvatarUrl = me.avatar_url || null;
        const wrap = document.getElementById('driver-avatar-picker-wrap');
        if (wrap) {
          wrap.innerHTML = avatarPickerHTML(me.avatar_url, me.id);
          initAvatarPicker('driver-avatar-picker-wrap', me.id, function(url) { _driverSelectedAvatarUrl = url; });
        }
      } catch (e) {
        console.warn('Failed to load profile:', e);
      }
    }

    async function saveProfile() {
      const msg = document.getElementById('profile-message');
      msg.textContent = '';
      const btn = document.querySelector('#account-panel .ro-btn--primary');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Saving...';
      try {
        const name = document.getElementById('profile-name').value.trim();
        const phone = document.getElementById('profile-phone').value.trim();
        const preferredName = document.getElementById('profile-preferred-name').value.trim();
        const major = document.getElementById('profile-major').value.trim();
        const gradYear = document.getElementById('profile-grad-year').value;
        const bio = document.getElementById('profile-bio').value.trim();
        const body = { name, phone, preferredName: preferredName || null, major: major || null, graduationYear: gradYear ? parseInt(gradYear, 10) : null, bio: bio || null };
        if (_driverSelectedAvatarUrl !== undefined) body.avatarUrl = _driverSelectedAvatarUrl;
        const res = await fetch('/api/me', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) {
          msg.textContent = data.error || 'Could not save profile';
          msg.style.color = 'var(--status-no-show)';
          return;
        }
        msg.textContent = 'Saved!';
        msg.style.color = 'var(--status-completed)';
        document.getElementById('driver-name').textContent = data.preferred_name || data.name;
        showToastNew('Profile updated', 'success');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function changePassword() {
      const msg = document.getElementById('pw-message');
      msg.textContent = '';
      msg.style.color = '';
      const currentPassword = document.getElementById('pw-current').value;
      const newPassword = document.getElementById('pw-new').value;
      const confirm = document.getElementById('pw-confirm').value;
      if (!currentPassword || !newPassword || !confirm) {
        msg.textContent = 'All fields are required.';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      if (newPassword.length < 8) {
        msg.textContent = 'New password must be at least 8 characters.';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      if (newPassword !== confirm) {
        msg.textContent = 'Passwords do not match.';
        msg.style.color = 'var(--status-no-show)';
        return;
      }
      const btn = document.querySelector('#account-panel .ro-btn--outline');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Updating...';
      try {
        const res = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const data = await res.json();
        if (!res.ok) {
          msg.textContent = data.error || 'Failed to change password';
          msg.style.color = 'var(--status-no-show)';
          return;
        }
        msg.textContent = 'Password updated successfully!';
        msg.style.color = 'var(--status-completed)';
        document.getElementById('pw-current').value = '';
        document.getElementById('pw-new').value = '';
        document.getElementById('pw-confirm').value = '';
        showToastNew('Password changed', 'success');
      } catch {
        msg.textContent = 'Connection error';
        msg.style.color = 'var(--status-no-show)';
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function toggleClock() {
      const me = employees.find(e => e.id === currentUser.id);
      if (!me) return;

      if (me.active) {
        const activeRideCount = rides.filter(r => r.assignedDriverId === currentUser.id && ACTIVE_STATUSES.includes(r.status)).length;
        const assignedRideCount = rides.filter(r => r.assignedDriverId === currentUser.id && ASSIGNED_OPEN_STATUSES.includes(r.status)).length;
        let message = 'Are you sure you want to clock out?';
        if (activeRideCount > 0) {
          message = `You have ${activeRideCount} active ${pluralize(activeRideCount, 'ride')}. Clock out anyway?`;
        } else if (assignedRideCount > 0) {
          message = `You still have ${assignedRideCount} assigned ${pluralize(assignedRideCount, 'ride')}. Clock out anyway?`;
        }
        showModalNew({
          title: 'Clock Out',
          body: message,
          confirmLabel: 'Clock Out',
          confirmClass: 'ro-btn--danger',
          onConfirm: () => doClockToggle(me)
        });
        return;
      }

      doClockToggle(me);
    }

    async function doClockToggle(me) {
      const endpoint = me.active ? 'clock-out' : 'clock-in';
      const response = await fetch(`/api/employees/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ employeeId: currentUser.id })
      });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Could not update clock status', 'error');
        return;
      }
      showToastNew(me.active ? 'Clocked out' : 'Clocked in', 'success');
      await loadData();
    }

    async function claim(id) {
      const response = await fetch(`/api/rides/${id}/claim`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: '{}'
      });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Failed to claim ride', 'error');
      } else {
        showToastNew('Ride claimed successfully', 'success');
      }
      await loadData();
    }

    async function action(id, act) {
      if (act === 'complete') {
        showModalNew({
          title: 'Complete Ride',
          body: 'Mark this ride as completed?',
          confirmLabel: 'Complete',
          confirmClass: 'ro-btn--success',
          onConfirm: () => doAction(id, act)
        });
        return;
      }
      if (act === 'no-show') {
        showModalNew({
          title: 'Confirm No-Show',
          body: 'Mark this rider as a no-show? This increases their no-show count.',
          confirmLabel: 'Mark No-Show',
          confirmClass: 'ro-btn--danger',
          onConfirm: () => doAction(id, act)
        });
        return;
      }
      doAction(id, act);
    }

    async function doAction(id, act) {
      const response = await fetch(`/api/rides/${id}/${act}`, { method: 'POST' });
      if (!response.ok) {
        const err = await response.json();
        showToastNew(err.error || 'Action failed', 'error');
        if (act === 'complete' && err.error && err.error.toLowerCase().includes('vehicle')) {
          showVehicleWarningBanner();
        }
      } else {
        const messages = {
          'on-the-way': 'Marked as on the way',
          here: 'Marked as arrived — grace timer started',
          complete: 'Ride completed',
          'no-show': 'Marked as no-show'
        };
        showToastNew(messages[act] || 'Action completed', 'success');
      }
      await loadData();
    }

    function startRide(rideId) {
      var options = vehicles.filter(function(v) { return v.status === 'available'; }).map(function(v) {
        return '<option value="' + v.id + '">' + v.name + '</option>';
      }).join('');

      var body = '<div style="margin-bottom:12px;">Which vehicle are you taking?</div>'
        + '<select id="modal-vehicle-select" class="form-select">'
        + '<option value="">Select a vehicle\u2026</option>'
        + options
        + '</select>';

      var overlay = document.createElement('div');
      overlay.className = 'ro-modal-overlay open';
      overlay.innerHTML =
        '<div class="ro-modal">' +
        '<div class="ro-modal__title">Confirm On My Way</div>' +
        '<div class="ro-modal__body">' + body + '</div>' +
        '<div class="ro-modal__actions">' +
        '<button class="ro-btn ro-btn--outline" data-action="cancel">Cancel</button>' +
        '<button class="ro-btn ro-btn--primary" data-action="confirm">Confirm</button>' +
        '</div></div>';
      document.body.appendChild(overlay);

      overlay.querySelector('[data-action="cancel"]').onclick = function() { overlay.remove(); };
      overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

      overlay.querySelector('[data-action="confirm"]').onclick = async function() {
        var vehicleId = document.getElementById('modal-vehicle-select').value;
        if (!vehicleId) {
          showToastNew('Please select a vehicle', 'warning');
          return;
        }
        var confirmBtn = overlay.querySelector('[data-action="confirm"]');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Starting\u2026';
        try {
          var svRes = await fetch('/api/rides/' + rideId + '/set-vehicle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vehicleId: vehicleId })
          });
          if (!svRes.ok) {
            var svErr = await svRes.json();
            showToastNew(svErr.error || 'Failed to set vehicle', 'error');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm';
            return;
          }
          var otwRes = await fetch('/api/rides/' + rideId + '/on-the-way', { method: 'POST' });
          if (!otwRes.ok) {
            var otwErr = await otwRes.json();
            showToastNew(otwErr.error || 'Failed to start ride', 'error');
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm';
            return;
          }
          overlay.remove();
          showToastNew('On your way!', 'success');
          loadData();
        } catch (err) {
          showToastNew('Network error', 'error');
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirm';
        }
      };
    }

    async function logout() {
      if (window._pollIntervals) {
        window._pollIntervals.forEach(id => clearInterval(id));
        window._pollIntervals = [];
      }
      await fetch('/api/auth/logout', { method: 'POST' });
      var parts = window.location.pathname.split('/').filter(Boolean);
      var slugs = ['usc', 'stanford', 'ucla', 'uci'];
      var org = (parts.length > 0 && slugs.indexOf(parts[0]) !== -1) ? parts[0] : null;
      window.location.href = org ? '/' + org : '/login';
    }

    init();
  </script>
</body>
</html>
