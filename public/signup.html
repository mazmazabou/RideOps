<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Account</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/dist/tabler-icons.min.css">
  <link rel="stylesheet" href="/css/rideops-theme.css">
</head>
<body class="d-flex flex-column">
  <div class="page page-center">
    <div class="container container-tight py-4">
      <div class="text-center mb-4">
        <h2 class="m-0" style="color: var(--tblr-primary);">Create Rider Account</h2>
        <p class="text-secondary mt-1">After signup, you'll land on the rider console.</p>
      </div>
      <div class="card card-md">
        <div class="card-body">
          <div id="error" class="alert alert-danger" style="display:none;"></div>
          <div id="success" class="alert alert-success" style="display:none;"></div>
          <form id="signup-form" autocomplete="off">
            <div class="mb-3">
              <label class="form-label" for="name">Full name</label>
              <input type="text" class="form-control" id="name" required placeholder="e.g. Alex Trojan">
            </div>
            <div class="mb-3">
              <label class="form-label" for="email">Email</label>
              <input type="email" class="form-control" id="email" required placeholder="you@example.com">
            </div>
            <div class="text-secondary small mb-3" id="username-note">Username will be set to the part before @ in your email.</div>
            <div class="row mb-3">
              <div class="col">
                <label class="form-label" for="phone">Phone (optional)</label>
                <input type="tel" class="form-control" id="phone" placeholder="213-555-0123">
              </div>
              <div class="col">
                <label class="form-label" for="uscid">USC ID (10 digits)</label>
                <input type="text" class="form-control" id="uscid" placeholder="1234567890" maxlength="10">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label" for="password">Password</label>
              <input type="password" class="form-control" id="password" required placeholder="At least 6 characters">
            </div>
            <div class="row">
              <div class="col">
                <button type="submit" class="btn btn-primary w-100">Sign Up</button>
              </div>
              <div class="col">
                <a href="/login" class="btn btn-outline-secondary w-100">Back to Login</a>
              </div>
            </div>
          </form>
          <div id="disabled-message" class="alert alert-danger mt-3" style="display:none;"></div>
        </div>
      </div>
      <div class="text-center mt-3">
        <a href="/login" class="text-primary fw-bold text-decoration-none">Already have an account? Log in</a>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/js/tabler.min.js"></script>
  <script src="/js/rideops-utils.js"></script>
  <script src="/demo-config.js"></script>
  <script>
    const emailInput = document.getElementById('email');
    const usernameNote = document.getElementById('username-note');

    emailInput.addEventListener('input', () => {
      const val = emailInput.value.trim().toLowerCase();
      if (val.includes('@') && val.indexOf('@') > 0) {
        const handle = val.split('@')[0];
        usernameNote.textContent = `Username will be: ${handle}`;
      } else {
        usernameNote.textContent = 'Username will be set to the part before @ in your email.';
      }
    });

    async function checkAllowed() {
      try {
        const res = await fetch('/api/auth/signup-allowed');
        if (!res.ok) return true;
        const data = await res.json();
        return !!data.allowed;
      } catch {
        return true;
      }
    }

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorEl = document.getElementById('error');
      const successEl = document.getElementById('success');
      const disabledEl = document.getElementById('disabled-message');
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      disabledEl.style.display = 'none';

      const allowed = await checkAllowed();
      if (!allowed) {
        disabledEl.textContent = 'Signup is currently disabled. Please contact the office.';
        disabledEl.style.display = 'block';
        return;
      }

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const uscid = document.getElementById('uscid').value.trim();
      const password = document.getElementById('password').value;

      if (!/^[0-9]{10}$/.test(uscid)) {
        errorEl.textContent = 'USC ID must be 10 digits.';
        errorEl.style.display = 'block';
        return;
      }

      try {
        const res = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone, password, uscId: uscid })
        });
        const data = await res.json();
        if (!res.ok) {
          errorEl.textContent = data.error || 'Signup failed';
          errorEl.style.display = 'block';
          return;
        }
        successEl.textContent = 'Account created! Redirecting...';
        successEl.style.display = 'block';
        setTimeout(() => { window.location.href = '/rider'; }, 600);
      } catch {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.style.display = 'block';
      }
    });
  </script>
</body>
</html>
