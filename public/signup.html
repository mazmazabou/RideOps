<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Account</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.2.0/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.31.0/tabler-icons.min.css">
  <link rel="stylesheet" href="/css/rideops-theme.css">
  <script src="/demo-config.js"></script>
  <style>
    body { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--color-page-bg); }
    .signup-wrap { width: 100%; max-width: 440px; padding: 24px; }
    .signup-card { background: var(--color-surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-md); padding: 32px 28px; }
    .signup-brand { display: flex; align-items: center; gap: 10px; justify-content: center; margin-bottom: 8px; }
    .signup-brand .ro-brand-icon { width: 36px; height: 36px; font-size: 13px; }
    .signup-brand-text { font-size: 18px; font-weight: 800; color: var(--color-text); }
    .signup-subtitle { text-align: center; font-size: 13px; color: var(--color-text-secondary); margin-bottom: 24px; }
    .field-group { margin-bottom: 14px; }
    .field-row { display: flex; gap: 12px; }
    .field-row > .field-group { flex: 1; min-width: 0; }
    .signup-error { color: var(--status-no-show); background: rgba(239,68,68,0.08); padding: 10px 14px; border-radius: var(--radius-sm); margin-bottom: 16px; font-size: 13px; font-weight: 600; display: none; }
    .signup-error.show { display: block; }
    .signup-success { color: var(--status-completed); background: rgba(16,185,129,0.08); padding: 10px 14px; border-radius: var(--radius-sm); margin-bottom: 16px; font-size: 13px; font-weight: 600; display: none; }
    .signup-success.show { display: block; }
    .username-note { font-size: 12px; color: var(--color-text-muted); margin-bottom: 14px; }
    .signup-actions { display: flex; gap: 10px; margin-top: 4px; }
    .signup-actions .ro-btn { flex: 1; }
    .bottom-link { text-align: center; margin-top: 16px; }
    .bottom-link a { color: var(--color-primary); font-weight: 700; text-decoration: none; font-size: 13px; }
    .bottom-link a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="signup-wrap">
    <div class="signup-card">
      <div class="signup-brand">
        <div class="ro-brand-icon">RO</div>
        <span class="signup-brand-text">Create Account</span>
      </div>
      <div class="signup-subtitle">Sign up as a rider to request accessible rides.</div>

      <div id="error" class="signup-error"></div>
      <div id="success" class="signup-success"></div>

      <form id="signup-form">
        <div class="field-group">
          <label class="ro-label" for="name">Full Name</label>
          <input type="text" id="name" class="ro-input" required placeholder="e.g. Alex Trojan">
        </div>
        <div class="field-group">
          <label class="ro-label" for="email">Email</label>
          <input type="email" id="email" class="ro-input" required placeholder="you@example.com">
        </div>
        <div class="username-note" id="username-note">Username will be set to the part before @ in your email.</div>
        <div class="field-row">
          <div class="field-group">
            <label class="ro-label" for="phone">Phone (optional)</label>
            <input type="tel" id="phone" class="ro-input" placeholder="213-555-0123">
          </div>
          <div class="field-group">
            <label class="ro-label" for="uscid">USC ID (10 digits)</label>
            <input type="text" id="uscid" class="ro-input" placeholder="1234567890" maxlength="10">
          </div>
        </div>
        <div class="field-group">
          <label class="ro-label" for="password">Password</label>
          <input type="password" id="password" class="ro-input" required placeholder="At least 6 characters">
        </div>
        <div class="signup-actions">
          <button type="submit" class="ro-btn ro-btn--primary ro-btn--action">Sign Up</button>
          <a href="/login" class="ro-btn ro-btn--outline ro-btn--action" style="text-decoration:none; text-align:center;">Back to Login</a>
        </div>
      </form>
      <div id="disabled-message" class="signup-error"></div>
    </div>
    <div class="bottom-link"><a href="/login">Already have an account? Log in</a></div>
  </div>
  <script>
    const emailInput = document.getElementById('email');
    const usernameNote = document.getElementById('username-note');

    emailInput.addEventListener('input', () => {
      const val = emailInput.value.trim().toLowerCase();
      if (val.includes('@') && val.indexOf('@') > 0) {
        const handle = val.split('@')[0];
        usernameNote.textContent = `Username will be: ${handle}`;
      } else {
        usernameNote.textContent = 'Username will be set to the part before @ in your email.';
      }
    });

    async function checkAllowed() {
      try {
        const res = await fetch('/api/auth/signup-allowed');
        if (!res.ok) return true;
        const data = await res.json();
        return !!data.allowed;
      } catch {
        return true;
      }
    }

    document.getElementById('signup-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const errorEl = document.getElementById('error');
      const successEl = document.getElementById('success');
      const disabledEl = document.getElementById('disabled-message');
      errorEl.classList.remove('show');
      successEl.classList.remove('show');
      disabledEl.classList.remove('show');

      const allowed = await checkAllowed();
      if (!allowed) {
        disabledEl.textContent = 'Signup is currently disabled. Please contact the office.';
        disabledEl.classList.add('show');
        return;
      }

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const uscid = document.getElementById('uscid').value.trim();
      const password = document.getElementById('password').value;

      if (!/^[0-9]{10}$/.test(uscid)) {
        errorEl.textContent = 'USC ID must be 10 digits.';
        errorEl.classList.add('show');
        return;
      }

      try {
        const res = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, phone, password, uscId: uscid })
        });
        const data = await res.json();
        if (!res.ok) {
          errorEl.textContent = data.error || 'Signup failed';
          errorEl.classList.add('show');
          return;
        }
        successEl.textContent = 'Account created! Redirecting...';
        successEl.classList.add('show');
        setTimeout(() => { window.location.href = '/rider'; }, 600);
      } catch {
        errorEl.textContent = 'Network error. Please try again.';
        errorEl.classList.add('show');
      }
    });
  </script>
</body>
</html>
