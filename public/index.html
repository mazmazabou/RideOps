<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Console</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.2.0/dist/css/tabler.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@3.37.1/dist/tabler-icons.min.css">
  <link rel="stylesheet" href="/css/rideops-theme.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
  <!-- Locations loaded dynamically from /api/locations -->
  <script src="/demo-config.js"></script>
</head>
<body>
  <div id="mobile-office-warning" style="display:none; position:fixed; inset:0; background:var(--color-page-bg); z-index:9999; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:32px; gap:16px;">
    <i class="ti ti-device-desktop" style="font-size:48px; color:var(--color-primary);"></i>
    <div style="font-size:20px; font-weight:800; color:var(--color-text);">Desktop Required</div>
    <div style="font-size:14px; color:var(--color-text-secondary); max-width:280px; line-height:1.6;">
      The RideOps Operations Console is optimized for desktop and tablet use. Please open this page on a larger screen.
    </div>
    <div style="font-size:12px; color:var(--color-text-muted); margin-top:8px;">
      Drivers and riders can use their role-specific mobile views.
    </div>
    <a id="mobile-warning-link" href="/demo.html" class="ro-btn ro-btn--outline" style="display:none; margin-top:8px;">Switch Role →</a>
  </div>
  <script>
    function checkMobileWarning() {
      var warning = document.getElementById('mobile-office-warning');
      if (!warning) return;
      var shell = document.querySelector('.ro-shell');
      if (window.innerWidth <= 480) {
        warning.style.display = 'flex';
        if (shell) shell.style.display = 'none';
      } else {
        warning.style.display = 'none';
        if (shell) shell.style.display = '';
      }
    }
    window.addEventListener('resize', checkMobileWarning);
    document.addEventListener('DOMContentLoaded', function() {
      checkMobileWarning();
      fetch('/api/auth/me').then(function(r) { return r.json(); }).then(function(u) {
        var link = document.getElementById('mobile-warning-link');
        if (link && u.demoMode) link.style.display = '';
      }).catch(function() {});
    });
  </script>
  <div class="ro-shell" id="app-shell">
    <!-- Sidebar -->
    <aside class="ro-sidebar">
      <div class="ro-sidebar-brand">
        <img src="/logoWithBackground.png" alt="RideOps" class="ro-brand-icon" id="org-initials" style="object-fit:cover;" />
        <div class="ro-brand-text">
          <span class="fw-700" id="org-short-name" style="font-size:14px;">RideOps</span>
          <span class="text-xs text-muted">Operations</span>
        </div>
        <button class="ro-sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
          <i class="ti ti-chevrons-left"></i>
        </button>
      </div>
      <nav class="ro-nav">
        <button class="ro-nav-item active" data-target="dispatch-panel" title="Dispatch">
          <i class="ti ti-broadcast"></i><span class="ro-nav-label">Dispatch</span>
        </button>
        <button class="ro-nav-item" data-target="rides-panel" title="Rides">
          <i class="ti ti-car"></i><span class="ro-nav-label">Rides</span>
        </button>
        <button class="ro-nav-item" data-target="staff-panel" title="Staff & Shifts">
          <i class="ti ti-users"></i><span class="ro-nav-label">Staff &amp; Shifts</span>
        </button>
        <button class="ro-nav-item" data-target="fleet-panel" title="Fleet">
          <i class="ti ti-bus"></i><span class="ro-nav-label">Fleet</span>
        </button>
        <button class="ro-nav-item" data-target="analytics-panel" title="Analytics">
          <i class="ti ti-chart-bar"></i><span class="ro-nav-label">Analytics</span>
        </button>
        <button class="ro-nav-item" data-target="settings-panel" title="Settings">
          <i class="ti ti-settings"></i><span class="ro-nav-label">Settings</span>
        </button>
      </nav>
      <div class="ro-sidebar-footer">
        <div class="ro-sidebar-footer-row">
          <button class="ro-nav-item" data-target="profile-panel" title="Profile">
            <i class="ti ti-user-circle"></i><span class="ro-nav-label" id="sidebar-user-name">Office</span>
          </button>
          <div class="ro-sidebar-footer-actions">
            <button onclick="showRulesModal()" title="Program Rules"><i class="ti ti-book"></i></button>
            <button onclick="logout()" title="Logout"><i class="ti ti-logout"></i></button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="ro-main">
      <header class="ro-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h1 class="ro-header-title" id="header-title">Dispatch</h1>
        <button class="notif-bell" id="notif-bell-btn" title="Notifications">
          <i class="ti ti-bell"></i>
          <span class="notif-badge" id="notif-badge"></span>
        </button>
      </header>

      <div class="ro-content">

        <!-- ═══ DISPATCH PANEL ═══ -->
        <section class="tab-panel active" id="dispatch-panel">
          <div class="kpi-bar" id="dispatch-kpis">
            <div class="kpi-card kpi-card--primary">
              <div class="kpi-card__value" id="dispatch-active-drivers">0</div>
              <div class="kpi-card__label">Active Drivers</div>
            </div>
            <div class="kpi-card kpi-card--pending">
              <div class="kpi-card__value" id="dispatch-pending-rides">0</div>
              <div class="kpi-card__label">Pending</div>
            </div>
            <div class="kpi-card kpi-card--progress">
              <div class="kpi-card__value" id="dispatch-active-rides">0</div>
              <div class="kpi-card__label">In Progress</div>
            </div>
            <div class="kpi-card kpi-card--completed">
              <div class="kpi-card__value" id="dispatch-completed-today">0</div>
              <div class="kpi-card__label">Completed Today</div>
            </div>
            <div class="kpi-card kpi-card--tardy">
              <div class="kpi-card__value" id="dispatch-tardy-today">0</div>
              <div class="kpi-card__label">Tardy Today</div>
            </div>
            <div class="kpi-card kpi-card--warning">
              <div class="kpi-card__value" id="dispatch-missing-drivers">0</div>
              <div class="kpi-card__label">No-Show</div>
            </div>
          </div>

          <!-- Pending queue -->
          <div class="ro-section">
            <div class="ro-section__header">
              <div>
                <h2 class="ro-section__title">Pending Queue</h2>
                <div class="ro-section__subtitle">Rides awaiting approval</div>
              </div>
            </div>
            <div id="pending-queue-list" class="strip-list"></div>
          </div>

          <!-- Today's Board (Time Grid) -->
          <div class="ro-section">
            <div class="ro-section__header">
              <h2 class="ro-section__title">Today's Board</h2>
              <input type="date" id="dispatch-date" class="ro-input" style="width:auto;">
            </div>
            <div class="time-grid" id="dispatch-grid"></div>
          </div>
        </section>

        <!-- ═══ RIDES PANEL ═══ -->
        <section class="tab-panel" id="rides-panel">
          <div class="ro-tabs">
            <button class="ro-tab active" data-subtarget="rides-active-view">Active Rides</button>
            <button class="ro-tab" data-subtarget="rides-calendar-view">Calendar</button>
            <button class="ro-tab" data-subtarget="rides-history-view">History</button>
          </div>

          <div class="sub-panel active" id="rides-active-view">
            <div class="filter-bar" id="rides-filter-bar">
              <button class="filter-pill active" data-ride-status="all">All</button>
              <button class="filter-pill" data-ride-status="pending">Pending</button>
              <button class="filter-pill" data-ride-status="approved">Approved</button>
              <button class="filter-pill" data-ride-status="scheduled">Scheduled</button>
              <button class="filter-pill" data-ride-status="in_progress">In Progress</button>
              <button class="filter-pill" data-ride-status="completed">Completed</button>
              <button class="filter-pill" data-ride-status="no_show">No-Show</button>
              <input type="date" id="rides-date-filter" class="ro-input" style="width:auto;">
              <input type="text" id="ride-filter-input" class="ro-input" placeholder="Search..." style="max-width:200px;">
              <span class="text-sm text-muted" id="ride-filter-count"></span>
            </div>
            <div class="ro-section">
              <div class="ro-table-wrap">
                <table class="ro-table" id="rides-table">
                  <thead><tr>
                    <th>Requested</th><th>Rider</th><th>Route</th><th>Status</th><th>Driver</th><th></th>
                  </tr></thead>
                  <tbody id="rides-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="sub-panel" id="rides-calendar-view">
            <div class="ro-section">
              <div class="flex items-center justify-between mb-16">
                <button class="ro-btn ro-btn--outline ro-btn--sm" id="ride-week-prev"><i class="ti ti-chevron-left"></i> Prev Week</button>
                <span class="text-sm fw-600" id="ride-week-label"></span>
                <button class="ro-btn ro-btn--outline ro-btn--sm" id="ride-week-next">Next Week <i class="ti ti-chevron-right"></i></button>
              </div>
              <div id="ride-schedule-grid"></div>
            </div>
          </div>

          <div class="sub-panel" id="rides-history-view">
            <div class="filter-bar">
              <input type="text" id="history-filter-input" class="ro-input" placeholder="Filter history by name, location, or status..." style="max-width:400px;">
            </div>
            <div class="ro-section" id="history-list">
              <div class="ro-section__header"><h3 class="ro-section__title">Completed &amp; No-Show History</h3></div>
              <div id="history-items"></div>
            </div>
          </div>
        </section>

        <!-- ═══ STAFF & SHIFTS PANEL ═══ -->
        <section class="tab-panel" id="staff-panel">
          <div class="ro-section">
            <div id="employee-bar" class="employee-bar"></div>
          </div>
          <div class="ro-section">
            <div id="shift-calendar" style="padding:0;"></div>
          </div>
        </section>

        <!-- ═══ FLEET PANEL ═══ -->
        <section class="tab-panel" id="fleet-panel">
          <div class="ro-section">
            <div class="ro-section__header">
              <h2 class="ro-section__title">Vehicles <i class="ti ti-info-circle" style="font-size:16px; color:var(--color-text-muted); cursor:pointer; vertical-align:middle;" title="Click for status definitions" onclick="showFleetStatusInfo()"></i></h2>
              <button class="ro-btn ro-btn--primary ro-btn--sm" id="add-vehicle-btn" type="button"><i class="ti ti-plus"></i> Add Vehicle</button>
            </div>
            <div id="vehicles-grid" class="vehicles-grid"></div>
          </div>
        </section>

        <!-- ═══ ANALYTICS PANEL ═══ -->
        <section class="tab-panel" id="analytics-panel">
          <div class="ro-tabs">
            <button class="ro-tab active" data-subtarget="analytics-dashboard-view">Dashboard</button>
            <button class="ro-tab" data-subtarget="analytics-hotspots-view">Hotspots</button>
            <button class="ro-tab" data-subtarget="analytics-milestones-view">Milestones</button>
            <button class="ro-tab" data-subtarget="analytics-reports-view">Reports</button>
            <button class="ro-tab" data-subtarget="analytics-tardiness-view">Attendance</button>
          </div>

          <!-- Date filter: visible across all sub-tabs -->
          <div class="analytics-date-bar">
            <div class="flex gap-8 items-center">
              <label class="ro-label" style="margin:0;">From</label>
              <input type="date" id="analytics-from" class="ro-input" style="width:auto;">
              <label class="ro-label" style="margin:0;">To</label>
              <input type="date" id="analytics-to" class="ro-input" style="width:auto;">
              <button class="ro-btn ro-btn--outline ro-btn--sm" id="analytics-refresh-btn" type="button"><i class="ti ti-refresh"></i> Refresh</button>
            </div>
          </div>

          <div class="sub-panel active" id="analytics-dashboard-view">
            <div class="analytics-card analytics-card--wide analytics-card--kpi" style="margin:16px 24px 0;">
              <div class="kpi-bar" id="analytics-kpi-grid"></div>
            </div>
            <div class="analytics-card-grid">
              <div class="analytics-card">
                <div class="analytics-card__header"><h4 class="analytics-card__title">Rides by Day of Week</h4></div>
                <div class="analytics-card__body" id="chart-dow"></div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card__header"><h4 class="analytics-card__title">Rides by Hour</h4></div>
                <div class="analytics-card__body" id="chart-hour"></div>
              </div>
              <div class="analytics-card analytics-card--wide">
                <div class="analytics-card__header"><h4 class="analytics-card__title">Daily Volume (Recent)</h4></div>
                <div class="analytics-card__body" id="chart-daily"></div>
              </div>
              <div class="analytics-card analytics-card--wide">
                <div class="analytics-card__header"><h4 class="analytics-card__title">Status Breakdown</h4></div>
                <div class="analytics-card__body" id="chart-status"></div>
              </div>
            </div>
          </div>

          <div class="sub-panel" id="analytics-hotspots-view">
            <div class="analytics-card-grid" style="padding-top:16px;">
              <div class="analytics-card">
                <div class="analytics-card__header"><h4 class="analytics-card__title"><i class="ti ti-map-pin"></i> Top Pickup Locations</h4></div>
                <div class="analytics-card__body" id="hotspot-pickups"></div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card__header"><h4 class="analytics-card__title"><i class="ti ti-map-pin-filled"></i> Top Dropoff Locations</h4></div>
                <div class="analytics-card__body" id="hotspot-dropoffs"></div>
              </div>
              <div class="analytics-card analytics-card--wide">
                <div class="analytics-card__header"><h4 class="analytics-card__title"><i class="ti ti-route"></i> Route Demand Matrix</h4></div>
                <div class="analytics-card__body" id="hotspot-matrix"></div>
              </div>
            </div>
          </div>

          <div class="sub-panel" id="analytics-milestones-view">
            <div class="analytics-card-grid" style="padding-top:16px;">
              <div class="analytics-card">
                <div class="analytics-card__header"><h4 class="analytics-card__title"><i class="ti ti-steering-wheel"></i> Driver Milestones</h4></div>
                <div class="analytics-card__body" id="driver-milestones"></div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card__header"><h4 class="analytics-card__title"><i class="ti ti-walk"></i> Rider Milestones</h4></div>
                <div class="analytics-card__body" id="rider-milestones"></div>
              </div>
            </div>
          </div>

          <div class="sub-panel" id="analytics-reports-view">
            <div class="analytics-card-grid" style="padding-top:16px;">
              <div class="analytics-card analytics-card--wide">
                <div class="analytics-card__header" style="display:flex;align-items:center;justify-content:space-between;">
                  <h4 class="analytics-card__title">Semester Report</h4>
                  <button class="csv-export-icon" id="export-csv-btn" type="button" title="Export CSV"><i class="ti ti-download"></i></button>
                </div>
                <div class="analytics-card__body" id="semester-report-content"></div>
              </div>
              <div class="analytics-card analytics-card--wide">
                <div class="analytics-card__header"><h4 class="analytics-card__title" id="ro-wrapped-title">RideOps Wrapped</h4></div>
                <div class="analytics-card__body" id="ro-wrapped-content"></div>
              </div>
            </div>
          </div>

          <div class="sub-panel" id="analytics-tardiness-view">
            <div id="tardiness-analytics-container"></div>
          </div>
        </section>

        <!-- ═══ SETTINGS PANEL ═══ -->
        <section class="tab-panel" id="settings-panel">
          <div class="ro-tabs">
            <button class="ro-tab active" data-subtarget="admin-users-view">Users</button>
            <button class="ro-tab" data-subtarget="admin-rules-view">Business Rules</button>
            <button class="ro-tab" data-subtarget="notif-settings">Notifications</button>
          </div>

          <div class="sub-panel active" id="admin-users-view">
            <div class="filter-bar">
              <input type="text" id="admin-user-filter" class="ro-input" placeholder="Search by name, email, phone, member ID, or role..." style="max-width:400px;">
            </div>
            <div class="ro-section">
              <div class="text-sm text-muted mb-16">Manage riders, drivers, and office accounts. You cannot delete your own office account.</div>
              <div class="ro-table-wrap">
                <table class="ro-table" id="admin-users-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Username</th>
                      <th>Role</th>
                      <th>Member ID</th>
                      <th>Phone</th>
                      <th></th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
                <div class="table-toolbar">
                  <span class="table-toolbar__count" id="admin-user-filter-count"></span>
                  <div class="table-toolbar__actions">
                    <div style="position:relative;">
                      <button class="table-toolbar__btn" id="admin-role-filter-btn" title="Filter by role"><i class="ti ti-filter"></i></button>
                    </div>
                    <button class="table-toolbar__btn" id="admin-export-csv-btn" title="Export CSV"><i class="ti ti-download"></i></button>
                    <button class="table-toolbar__btn table-toolbar__btn--add" id="admin-add-user-btn" title="Add user"><i class="ti ti-plus"></i></button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="sub-panel" id="admin-rules-view">
            <div id="business-rules-container" class="p-24"></div>
          </div>

          <div class="sub-panel" id="notif-settings">
            <div id="notif-prefs-container" class="p-24"></div>
          </div>
        </section>

        <!-- ═══ PROFILE PANEL ═══ -->
        <section class="tab-panel" id="profile-panel">
          <div class="ro-section">
            <div id="admin-profile-content"></div>
          </div>
        </section>

      </div><!-- /ro-content -->
    </main>
  </div>

  <!-- Admin Drawer (used by Settings panel) -->
  <div id="admin-drawer-backdrop" class="ro-drawer-overlay"></div>
  <aside id="admin-drawer" class="ro-drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 id="admin-drawer-title" style="font-size:16px; font-weight:700; margin:0;">User Details</h3>
      <button class="ro-btn ro-btn--outline ro-btn--sm" id="admin-drawer-close"><i class="ti ti-x"></i></button>
    </div>
    <div id="admin-drawer-body"></div>
  </aside>

  <!-- Vehicle Drawer (used by Fleet panel) -->
  <div id="vehicle-drawer-backdrop" class="ro-drawer-overlay"></div>
  <aside id="vehicle-drawer" class="ro-drawer">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 id="vehicle-drawer-title" style="font-size:16px; font-weight:700; margin:0;">Vehicle Details</h3>
      <button class="ro-btn ro-btn--outline ro-btn--sm" id="vehicle-drawer-close"><i class="ti ti-x"></i></button>
    </div>
    <div id="vehicle-drawer-body"></div>
  </aside>

  <script src="/utils.js"></script>
  <script src="/js/rideops-utils.js"></script>
  <script src="app.js"></script>
  <script>
    // Initialize new navigation system after app.js loads
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof initSidebar === 'function') initSidebar();
      if (typeof initSubTabs === 'function') initSubTabs();
      if (typeof restoreSidebarState === 'function') restoreSidebarState();
    });
  </script>
</body>
</html>
